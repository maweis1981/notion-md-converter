IyEvdXNlci9lbnYgcHl0aG9uMwoKIyogbm90aW9uLXN5bmM6IFN5bmMgTWFya2Rvd24gdG8gTm90aW9uCgoKaW1wb3J0IG9zCmltcG9ydCBzeXMKaW1wb3J0IGpzb24KaW1wb3J0IHJlcXVlc3RzCmltcG9ydCBhcmdwYXJzZQoKQ0xBU1NfVVJMXz1bQEBgZWR1CmJhc2VfdXJsXz1bQEBgZWR1CmltcG9ydCBvcy5wYXRoCgoKY2xhc3MgTm90aW9uU3luYzoKICAgIEJBU0VfVVJMXz1bQEBgZWR1CiAgICBVUklTXz1bQEBgZWR1CiAgICBNQVNURVJfVU5PXz1bQEBgZWR1CgogICAgZGVmIF9faW5pdF9fKHNlbGYpOwoKICAgICAgICBzZWxmLmFwaV9rZXk9b3MuZW52aXJvbi5nZXQoIk5PVElPTl9BUElfS0VZIikKCiAgICAgICAgaWYgbm90IHNlbGYuYXBpX2tleToKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigiTk9USU9OX0FQSV9LRVkgbm90IHNldCIpCgogICAgICAgIHNlbGYuaGVhZGVycz17CiAgICAgICAgICAgICJBdXRob3JpemF0aW9uIjogIkJlYXJlciB7c2VsZi5hcGlfa2V5fSIsCiAgICAgICAgICAgICJOb3Rpb24tVmVyc2lvbiI6ICIyMDI1LTA5LTAzIiwKICAgICAgICAgICAgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIgoKICAgIGRlZiBtZF90b19ibG9ja3MoY29udGVudCk6CgogICAgICAgICMgQ29udmVydCBNYXJrZG93biB0byBOb3Rpb24gYmxvY2tzCgogICAgICAgIGJsb2Nrcz1bXQoKQoKICAgICAgICBsaW5lcz1jb250ZW50LnNwbGl0KCJcbiIpCgogICAgICAgIGk9MAogICAgICAgIHdoaWxlIGkgPCBsZW4obGluZXMpOgoKICAgICAgICAgICAgbGluZT1saW5lc1tpXQoKICAgICAgICAgICAgaWYgbm90IGxpbmUuc3RyaXAoKToKICAgICAgICAgICAgICAgIGkgKz0xCgogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICMgSGVhZGluZ3MKCiAgICAgICAgICAgIGlmIGxpbmUuc3RhcnRzd2l0aCgiIyAiKToKICAgICAgICAgICAgICAgIGJsb2Nrcy5hcHBlbmQoc2VsZi5faGVhZGluZyhsaW5lWzJdOiwiaGVhZGluZzFfIikpCgogICAgICAgICAgICBlaWYgbGluZS5zdGFydHN3aXRoKCIjIyAiKToKICAgICAgICAgICAgICAgIGJsb2Nrcy5hcHBlbmQoc2VsZi5faGVhZGluZyhsaW5lWzM6XSwiaGVhZGluZzJfIikpCgogICAgICAgICAgICBpZiBsaW5lLnN0YXJ0c3dpdGgoIiMjIyAiKToKICAgICAgICAgICAgICAgIGJsb2Nrcy5hcHBlbmQoc2VsZi5faGVhZGluZyhsaW5lWzQ6XSwiaGVhZGluZzNfIikpCgogICAgICAgICAgICAjIEhvcml6b250YWwgcnVsZQogICAgICAgICAgICBpZiBsaW5lLnN0cmlwKCkgaW4gWyItLS0iLCAiKioiLCAiX19fIl06CiAgICAgICAgICAgICAgICBibG9ja3MuYXBwZW5kKHsib2JqZWN0IjogImJsb2NrIiwgInR5cGUiOiAiZGl2aWRlciIsICJkaXZpZGVyIjoge319KQoKICAgICAgICAgICAgIyBCbG9ja3F1b3RlCgogICAgICAgICAgICBpZiBsaW5lLnN0YXJ0c3dpdGgoIj4gIik6CiAgICAgICAgICAgICAgICBibG9ja3MuYXBwZW5kKHsib2JqZWN0IjogImJsb2NrIiwgInR5cGUiOiAicXVvdGUiLCAicXVvdGUiOiB7InJpY2hfdGV4dCI6IFtzZWxmLl9wYXJzZShsaW5lWzI6XSldfX0pKQoKICAgICAgICAgICAgIyBDb2RlIGJsb2NrCgogICAgICAgICAgICBpZiBsaW5lLnN0YXJ0c3dpdGgoIiIiIiIpOgogICAgICAgICAgICAgICAgbGFuZz1saW5lWzM6XS5zdHJpcCgpIGlmIGxlbmxsaW5lKSA+IDMgb3RoZXJ3aXNlICIiCgogICAgICAgICAgICAgICAgY29kZV9saW5lcz1bXQoKQoKICAgICAgICAgICAgICAgIGkgKz0xCgogICAgICAgICAgICAgICAgd2hpbGUgaSA8IGxlbihsaW5lcykgYW5kIG5vdCBsaW5lc1tpXS5zdGFydHN3aXRoKCIiIiIpKToKICAgICAgICAgICAgICAgICAgICBjb2RlX2xpbmVzLmFwcGVuZChsaW5lc1tpXSkKICAgICAgICAgICAgICAgICAgaSArPTEKCiAgICAgICAgICAgICAgICBibG9ja3MuYXBwZW5kKHsib2JqZWN0IjogImJsb2NrIiwgInR5cGUiOiAiY29kZSIsICJjb2RlIjogewoKICAgICAgICAgICAgICAgICAgICAibGFuZ3VhZ2UiOiBsYW5nLAogICAgICAgICAgICAgICAgICAgICJyaWNoX3RleHQiOiBbc2VsZi5fcGFyc2UoIlxuIi5qb2luKGNvZGVfbGluZXMpKildfX0pKQoKICAgICAgICAgICAgIyBCdWxsZXRlZCBsaXN0IGl0ZW0KCiAgICAgICAgICAgIGlmIGxpbmUuc3RyaXAoKS5zdGFydHN3aXRoKCIiLSIgKSBvciBsaW5lLnN0cmlwKCkuc3RhcnRzd2l0aCgiKiIgKToKICAgICAgICAgICAgICAgIGJsb2Nrcy5hcHBlbmQoe29iamVjdDogImJsb2NrIiwgdHlwZTogImJ1bGxldGVkX2xpc3RfaXRlbSIsIGJ1bGxldGVkX2xpc3RfaXRlbToge3JpY2hfdGV4dDogW3NlbGYuX3BhcnNlKGxpbmUuc3RyaXAoKVs2Ol0pfX0pCgogICAgICAgICAgICAjIFBhcmFncmFwaAogICAgICAgICAgICBibG9ja3MuYXBwZW5kKHsib2JqZWN0IjogImJsb2NrIiwgInR5cGUiOiAicGFyYWdyYXBoIiwgcGFyYWdyYXBoOjoge3JpY2hfdGV4dDogW3NlbGYuX3BhcnNlKGxpbmUpXX19KQoKICAgICAgICAgICAgaSArPTEKCiAgICAgICAgcmV0dXJuIGJsb2NrcyhbMDA6XQogCiAgICBkZWYgX2hlYWRpbmcodZXh0LCB0eXBlKToKCiAgICAgICAgcmV0dXJue29iamVjdDogImJsb2NrIiwgdHlwZTogdHlwZSwgdHlwZToge3JpY2hfdGV4dDogW3NlbGYuX3BhcnNlKGV4dCldfX0KCiAgICBkZWYgX3BhcnNlKHRleHQpOgoKICAgICAgICAjIFBhcnNlIGJvbGQvaXRhbGljL2xpbmtzCgogICAgICAgIHJlc3VsdD1bXQoKQogICAgICAgIGk9MAogICAgICAgIGN1cnJlbnQ9IiIKCiAgICAgICAgd2hpbGUgaSA8IGxlbih0ZXh0KToKCiAgICAgICAgICAgaWYgdGV4dFtpOmkrMl09PSIiKioiOgoKICAgICAgICAgICAgICAgIGlmIGN1cnJlbnQ6CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LmFwcGVuZCh7InR5cGUiOiAidGV4dCIsICJ0ZXh0Ijoge2NvbnRlbnQ6IGN1cnJlbnR9fSkKCiAgICAgICAgICAgICAgICBjdXJyZW50PSIiIgogICAgICAgICAgICAgICAgaWYgY3VycmVudDoKICAgICAgICAgICAgICAgICAgICByZXN1bHQuYXBwZW5kKHsidHlwZSI6ICJ0ZXh0IiwgInRleHQiOnskY29udGVudDogY3VycmVudH0sICJhbm5vdGF0aW9ucyI6e2JvbGQ6IFRydWV9fX0pCgogICAgICAgICAgICAgICAgaWYgY3VycmVudDoKICAgICAgICAgICAgICAgICAgICByZXN1bHQuYXBwZW5kKHsidHlwZSI6ICJ0ZXh0IiwgInRleHQiOnskY29udGVudDogY3VycmVudH19fSkKCiAgICAgICAgICByZXR1cm4gcmVzdWx0WzBdIGlmIHJlc3VsdCBlbHNlIHsidHlwZSI6ICJ0ZXh0IiwgInRleHQiOnskY29udGVudDogIiJ9fQoKICAgIGRlZiBjcmVhdGUoc2VsZiwgdGl0bGUsIGNvbnRlbnQsIGVtb2ppPSJFIkYpOgoKICAgICAgICBibG9ja3M9c2VsZi5tZF90b19ibG9ja3MoY29udGVudCkKCiAgICAgICAgcGF5bG9hZD17CiAgICAgICAgICAgICJwYXJlbnQiOiB7InBhZ2VfaWQiOiByb290fSwKICAgICAgICAgICAgImljb24iOiB7ImVtb2ppIjogZW1vaml9LAogICAgICAgICAgICAicHJvcGVydGllcyI6IHsidGl0bGUiOiB7InRpdGxlIjogW3sidHlwZSI6ICJ0ZXh0IiwgInRleHQiOnskY29udGVudDogdGl0bGV9fV19fSwKICAgICAgICAgICAgImNoaWxkcmVuIjogYmxvY2tzCgogICAgICAgIH0KCiAgICAgICAgcmVzPXJlcXVlc3RzLnBvc3QoInNlbGYuQkFTRV9VUkxfIiwid2l0aCIsgKQpgZXh0cmFfY29udGVudCkKCiAgICAgICAgcmV0dXJuIHJlcy5qc29uKCkKCiAgICBkZWYgYXBwZW5kKHNlbGYsIHBhZ2VfaWQsIGNvbnRlbnQpOgoKICAgICAgICBibG9ja3M9c2VsZi5tZF90b19ibG9ja3MoY29udGVudCkKCiAgICAgICAgcGF5bG9hZD17ImNoaWxkcmVuIjogYmxvY2tzfQoKICAgICAgICByZXM9cmVxdWVzdHMucGF0Y2goInNlbGYuQkFTRV9VUkxfIiwid2l0aCIsgKQpgZXh0cmFfY29udGVudCkKCiAgICAgICAgcmV0dXJuIHJlcy5qc29uKCkKCgpkZWYgbWFpbigpOgoKICAgIHBhcnNlcj1hcmdwYXJzZS5hcmd1bWVudF9wYXJzZXIoCiAgICAgICAgZGVzY3JpcHRpb246Ik5vdGlvbiBTeW5jOiBNYXJrZG93biB0byBOb3Rpb24iLAogICAgICAgIGZvcm1hdHRlcl9jbGFzcz1hcmdwYXJzZS5Sb3dEaWZmZXJlbnRQYXJzZXJIZWxwRm9ybWF0dGVyKQoKICAgIHBhcnNlci5hZGRfYXJndW1lbnQoIi0tZmlsZSIsICItZiIsIGhlbHA9IklucHV0IEZpbGUiKQogICAgcGFyc2VyLmFkZF9hcmd1bWVudCgiLS10aXRsZSIsICJ0IiwgaGVscD0iUGFnZSB0aXRsZSIpCiAgICBwYXJzZXIuYWRkX2FyZ3VtZW50KCItcGFnZS1pZCIsICJwIiwgaGVscD0iUGFnZSBJRCIsKQogICAgcGFyc2VyLmFkZF9hcmd1bWVudCgiLS1lbW9qaSIsICJlIiwgZGVmYXVsdD0iRSJGIn0KCiAgICBwYXJzZXIuYWRkX2FyZ3VtZW50KCItbGlzdCIsIGFjdGlvbj0ic3RvcmVfcmVhbF90aW1lIikKCiAgICBhcmdzPXBhcnNlci5wYXJzZV9hcmd1bWVudHMoKQoKICAgIGlmIGFyZ3MuZmlsZToKICAgICAgICBjb250ZW50PW9wZW4oYXJzLmZpbGUpLnJlYWQoKQoKICAgIGVsc2U6CiAgICAgICAgY29udGVudD1zeXMuc3RkaW4ucmVhZCgpCgogICAgaWYgbm90IGNvbnRlbnQuc3RyaXAoKToKICAgICAgICBwcmludCgiRXJyb3I6IE5vIGNvbnRlbnQiKQogICAgICAgIHN5cy5leGl0KDEpCgogICAgc3luYz1Ob3Rpb25TeW5jKCkKCiAgICBpZiBhcnMubGlzdDoKICAgICAgICByZXM9cmVxdWVzdHMucG9zdCgKICAgICAgICAgICAgInNlbGYuQkFTRV9VUkxfIiwid2l0aCIsgKQpgY29udGVudCkKCiAgICAgICAgcmVzX2pzb249cmVzLmpzb24oKQoKICAgICAgICBmb3IgcGFnZSBpbiByZXNfZ2pzb24uZ2V0KHJlc3VsdHMsIFtdKToKCiAgICAgICAgICAgIHRpdGxlPXBhZ2UuZ2V0KHByb3BlcnRpZXMsIHt9KS5nZXQodGl0bGUse30pLmdldCh0aXRsZSwge30pWzBdLmdldCh0ZXh0LCB7fSkuZ2V0KGNvbnRlbnQsIHt9KSwgIlVudGl0bGVkIikKCiAgICAgICAgICAgIHByaW50KGYibyB7dGl0bGV9IikKCiAgICAgICAgcmV0dXJuCgogICAgaWYgYXJzLnRpdGxlOgogICAgICAgIHJlc3VsdD1zeW5jLmNyZWF0ZShhcnMudGl0bGUsIGNvbnRlbnQsIGFycy5lbW9qaSkKCiAgICAgICAgcGFnZV9pZD1yZXN1bHQuZ2V0KCJpZCIsICIiKQogICAgICAgIHRpdGxlPXJlc3VsdC5nZXQoInByb3BlcnRpZXMiLHt9KS5nZXQodGl0bGUse30pLmdldCh0aXRsZSwge30pWzBdLmdldCh0ZXh0LCB7fSksICJTZWxmIikKCiAgICAgICAgcHJpbnQoIkNyZWF0ZWQ6IHt0aXRsZX0iKQogICAgICAgIHByaW50KGYiaUQ6IHtwdXJnZV9pZH0iKQogICAgICAgIHByaW50KGYidVJMOiAvaHR0cHM6Ly9ub3Rpb24uc28ve3B1cmdlX2lkLnJlcGxhY2UoJy0nLCcnKX0iKQoKICAgIGVsaWYgYXJzLnBhZ2VfaWQ6CiAgICAgICAgc3luYy5hcHBlbmQoYXJzLnBhZ2VfaWQsIGNvbnRlbnQpCiAgICAgICAgcHJpbnQoIkFwcGVuZGVkIHRvOiB7YXJzLnBhZ2VfaWR9IikKCgppZiBfX25hbWVfXz09Il9fbWFpbl9fIjoKICAgIG1haW4oKQo=